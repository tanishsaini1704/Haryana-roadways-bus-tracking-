<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haryana Bus Tracker (Live)</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === Basic Styling & Font === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
        
        /* === Animated Background Particles (Original Animation) === */
        .bg-particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .particle { position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; animation: fadeInUp 0.8s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* === Header (Original Animation) === */
        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); animation: slideInDown 0.6s ease-out; }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .app-title { display: flex; align-items: center; gap: 15px; font-size: 28px; margin-bottom: 10px; color: #1a73e8; font-weight: 700; }
        .app-title i { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        .subtitle { color: #666; font-size: 16px; margin-left: 43px; }

        /* === Main Layout & Sidebar (Original Animation) === */
        .main-content { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 160px); }
        .sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow-y: auto; animation: slideInLeft 0.8s ease-out; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }

        /* === Search Tabs & Form Elements === */
        .search-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background: transparent; font-size: 15px; font-weight: 600; color: #666; position: relative; transition: color 0.2s ease; }
        .tab-button.active { color: #1a73e8; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: #1a73e8; }
        .search-panel { display: none; }
        .search-panel.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group select, .input-group input { width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 14px; outline: none; transition: border-color 0.2s ease; }
        .input-group select:focus, .input-group input:focus { border-color: #1a73e8; }
        
        /* === Button (Original Animation) === */
        .btn { background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(26, 115, 232, 0.4); }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }

        /* === Bus List & Cards (Original Animation) === */
        .bus-list { display: flex; flex-direction: column; gap: 12px; }
        .bus-card { border: 2px solid rgba(225, 229, 233, 0.3); border-radius: 15px; padding: 15px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); position: relative; overflow: hidden; animation: cardSlideIn 0.6s ease-out; }
        @keyframes cardSlideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        .bus-card:hover { border-color: #1a73e8; transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 30px rgba(26, 115, 232, 0.2); }
        .bus-card.selected { border-color: #1a73e8; background: #e9f3ff; transform: translateY(-3px) scale(1.02); }
        .bus-number { font-size: 16px; font-weight: 700; color: #1a73e8; }
        .bus-status { font-size: 13px; color: #666; }
        
        /* === Map Area (Original Animation) === */
        .map-container { background: white; border-radius: 15px; overflow: hidden; position: relative; animation: slideInRight 0.8s ease-out; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        .map-overlay { position: absolute; bottom: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; font-size: 13px; color: #333; }
        #map { width: 100%; height: 100%; min-height: 600px; }
        
        /* === Loading Spinner === */
        .loading { display: flex; align-items: center; justify-content: center; height: 150px; flex-direction: column; gap: 15px; text-align: center; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1a73e8; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(26, 115, 232, 0.3); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="bg-particles" id="particles"></div>
    <div class="container">
        <header>
            <div class="app-title"><i class="fas fa-bus"></i> Haryana Bus Tracker</div>
            <div class="subtitle">Real-time tracking of government buses across Haryana</div>
        </header>
        <div class="main-content">
            <div class="sidebar">
                <div class="search-section">
                    <!-- Search Tabs -->
                    <div class="search-tabs">
                        <button class="tab-button active" onclick="switchTab('route')">Search by Route</button>
                        <button class="tab-button" onclick="switchTab('bus-number')">Search by Bus No.</button>
                    </div>
                    
                    <!-- Search by Route Panel -->
                    <div id="route-panel" class="search-panel active">
                        <div class="input-group">
                            <label for="from-city">From</label>
                            <select id="from-city">
                                <option value="">Select Departure City</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="to-city">To</label>
                            <select id="to-city">
                                <option value="">Select Destination City</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Search by Bus Number Panel -->
                    <div id="bus-number-panel" class="search-panel">
                        <div class="input-group">
                            <label for="bus-number-input">Bus Number</label>
                            <input type="text" id="bus-number-input" placeholder="e.g., HR55A1234">
                        </div>
                    </div>
                    
                    <button class="btn" id="search-btn" onclick="searchByRoute()"><i class="fas fa-search"></i> Find Buses</button>
                </div>
                <div class="buses-section">
                    <div id="bus-list" class="bus-list">
                        <div class="loading"><div class="spinner"></div><span>Waiting for live data...</span></div>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
                <div class="map-overlay">
                    <div id="update-indicator">Connecting to live feed...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // === Configuration ===
        const API_BASE_URL = 'http://127.0.0.1:5000'; // Your Flask server address
        const POLLING_INTERVAL_MS = 3000; // Fetch data every 3 seconds

        // Global variables
        let map;
        let infoWindow;
        let icons = {};
        let liveBusesData = [];
        let busMarkersOnMap = {};
        let currentRouteKey = null;
        let routePolyline = null;
        
        const CITIES = {
            chandigarh: "Chandigarh", gurgaon: "Gurgaon", ambala: "Ambala", hisar: "Hisar",
            rohtak: "Rohtak", faridabad: "Faridabad", karnal: "Karnal", sonipat: "Sonipat",
            panipat: "Panipat", yamunanagar: "Yamunanagar", sirsa: "Sirsa", rewari: "Rewari"
        };
        
        // Populate dropdowns with city names
        function populateCityDropdowns() {
            const fromCitySelect = document.getElementById('from-city');
            const toCitySelect = document.getElementById('to-city');
            const sortedCities = Object.keys(CITIES).sort();

            sortedCities.forEach(cityKey => {
                fromCitySelect.add(new Option(CITIES[cityKey], cityKey));
                toCitySelect.add(new Option(CITIES[cityKey], cityKey));
            });
        }

        // ====================================================================================
        // === LIVE DATA FETCHER (POLLING) - THIS IS THE APP'S ENGINE ===
        // ====================================================================================
        async function fetchLiveBusData() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_live_buses`);
                if (!response.ok) {
                    document.getElementById('update-indicator').textContent = 'Server Error!';
                    return;
                }
                const data = await response.json();
                liveBusesData = data;
                updateBusListAndMarkers();
                document.getElementById('update-indicator').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                document.getElementById('update-indicator').textContent = 'Connection Failed!';
            }
        }
        
        // Update bus list and map markers with new data
        function updateBusListAndMarkers() {
            const busList = document.getElementById('bus-list');
            let visibleBuses = currentRouteKey ? liveBusesData.filter(bus => bus.routeKey === currentRouteKey) : [];
            
            // Update or create markers for all live buses
            liveBusesData.forEach(bus => {
                const newPosition = new google.maps.LatLng(bus.latitude, bus.longitude);
                if (busMarkersOnMap[bus.id]) {
                    // If marker exists, update its position and direction
                    const marker = busMarkersOnMap[bus.id];
                    marker.setPosition(newPosition);
                    const currentIcon = marker.getIcon();
                    currentIcon.rotation = bus.bearing;
                    marker.setIcon(currentIcon);
                } else {
                    // Create a new marker if it doesn't exist
                    const marker = new google.maps.Marker({
                        position: newPosition, map: map,
                        icon: { ...icons.bus, rotation: bus.bearing }
                    });
                     marker.addListener('click', () => {
                        infoWindow.setContent(`<div style="text-align:center;"><h4>${bus.number}</h4><p>${bus.status}</p></div>`);
                        infoWindow.open(map, marker);
                    });
                    busMarkersOnMap[bus.id] = marker;
                }
                // Show or hide marker based on the selected route
                busMarkersOnMap[bus.id].setVisible(bus.routeKey === currentRouteKey);
            });

            // Update the sidebar list
            busList.innerHTML = '';
            if(!currentRouteKey) {
                busList.innerHTML = `<div class="loading"><span>Select a route to see live buses.</span></div>`;
            } else if (visibleBuses.length === 0) {
                busList.innerHTML = `<div class="loading"><span>No live buses found on this route.</span></div>`;
            }

            visibleBuses.sort((a,b) => a.number.localeCompare(b.number)).forEach((bus, index) => {
                const busCard = document.createElement('div');
                busCard.className = 'bus-card';
                busCard.style.animationDelay = `${index * 0.1}s`; // Staggered animation
                busCard.innerHTML = `<div class="bus-number">${bus.number}</div>
                                     <div class="bus-status">${bus.status}</div>`;
                // Hover interaction
                busCard.addEventListener('mouseover', () => busMarkersOnMap[bus.id].setAnimation(google.maps.Animation.BOUNCE));
                busCard.addEventListener('mouseout', () => busMarkersOnMap[bus.id].setAnimation(null));
                // Click interaction
                busCard.addEventListener('click', () => {
                    map.panTo(busMarkersOnMap[bus.id].getPosition());
                    map.setZoom(12);
                    document.querySelectorAll('.bus-card').forEach(c => c.classList.remove('selected'));
                    busCard.classList.add('selected');
                });
                busList.appendChild(busCard);
            });
        }
        
        // Function to search by route
        async function searchByRoute() {
            const fromCity = document.getElementById('from-city').value;
            const toCity = document.getElementById('to-city').value;
            if (!fromCity || !toCity || fromCity === toCity) {
                alert("Please select valid and different cities.");
                return;
            }
            currentRouteKey = `${fromCity}-${toCity}`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/get_route?start=${fromCity}&end=${toCity}`);
                if (!response.ok) {
                    alert('This route was not found on the server.');
                    return;
                }
                const data = await response.json();
                showRoadRoute(data.route);
                updateBusListAndMarkers();
            } catch (error) {
                alert('Error fetching route data.');
            }
        }
        
        // Draw the route line on the map
        function showRoadRoute(routeCoords) {
            if (routePolyline) routePolyline.setMap(null);
            if (!routeCoords) return;
            routePolyline = new google.maps.Polyline({
                path: routeCoords, strokeColor: '#1a73e8',
                strokeOpacity: 0.8, strokeWeight: 5, map: map
            });
            const bounds = new google.maps.LatLngBounds();
            routeCoords.forEach(point => bounds.extend(point));
            map.fitBounds(bounds, {padding: 50});
        }
        
        // Function to search by bus number
        async function searchByBusNumber() {
            const busNumberInput = document.getElementById('bus-number-input').value.trim().toUpperCase().replace(/-/g, '');
            if (!busNumberInput) return;
            const foundBus = liveBusesData.find(b => b.number.replace(/-/g, '') === busNumberInput);
            if(foundBus) {
                currentRouteKey = foundBus.routeKey;
                const [from, to] = currentRouteKey.split('-');
                
                // Fetch and draw the route for the found bus
                 try {
                    const response = await fetch(`${API_BASE_URL}/get_route?start=${from}&end=${to}`);
                    const data = await response.json();
                    showRoadRoute(data.route);
                    updateBusListAndMarkers();
                } catch (error) { /* handle error */ }
                
                // Focus on the bus after a short delay
                setTimeout(() => { 
                    const marker = busMarkersOnMap[foundBus.id];
                    if(marker) {
                        map.panTo(marker.getPosition());
                        map.setZoom(14);
                        google.maps.event.trigger(marker, 'click'); // Open info window
                    }
                }, 500);

            } else {
                alert("This bus was not found in the live feed.");
            }
        }

        // Initialize background particles (Original Animation)
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 4 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 6}s`;
                particle.style.animationDuration = `${Math.random() * 3 + 3}s`;
                particlesContainer.appendChild(particle);
            }
        }
        
        // Initialize the map when the page loads
        function initMap() {
             icons = { bus: { path: 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z', fillColor: '#1a73e8', fillOpacity: 1, strokeColor: 'white', strokeWeight: 1, scale: 1.3, anchor: new google.maps.Point(12, 12)} };
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 29.0588, lng: 76.0856 }, zoom: 8, mapTypeControl: false, streetViewControl: false, styles: [ { stylers: [{ "saturation": -100 }] }] });
            infoWindow = new google.maps.InfoWindow();
            
            createParticles();
            populateCityDropdowns();
            // Start fetching live data as soon as the map is ready
            fetchLiveBusData();
            // And keep fetching every 3 seconds
            setInterval(fetchLiveBusData, POLLING_INTERVAL_MS);
        }

        // Function to switch between search tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button, .search-panel').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            const searchBtn = document.getElementById('search-btn');
            searchBtn.innerHTML = tabName === 'route' ? '<i class="fas fa-search"></i> Find Buses' : '<i class="fas fa-crosshairs"></i> Track Bus';
            searchBtn.onclick = tabName === 'route' ? searchByRoute : searchByBusNumber;
        }
    </script>
    <!-- REMEMBER TO REPLACE 'YOUR_API_KEY' WITH YOUR ACTUAL GOOGLE MAPS API KEY -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqFb_0TMh3ptL2FpIMDqjhk9i-Ps2Zhpg&callback=initMap"></script>
</body>
</html>