<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haryana Bus Tracker (Live)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All CSS is the same */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .app-title { display: flex; align-items: center; gap: 15px; font-size: 28px; margin-bottom: 10px; color: #1a73e8; font-weight: 700; }
        .subtitle { color: #666; font-size: 16px; margin-left: 43px; }
        .main-content { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 185px); }
        .sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow-y: auto; }
        .search-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background: transparent; font-size: 15px; font-weight: 600; color: #666; position: relative; }
        .tab-button.active { color: #1a73e8; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: #1a73e8; }
        .search-panel { display: none; }
        .search-panel.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group select, .input-group input { width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 14px; outline: none; }
        .btn { background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 10px; }
        .route-info-panel { background: #e9f3ff; border: 1px solid #c4d9f0; padding: 15px; margin: 20px 0; border-radius: 12px; display: none; }
        .route-info-panel h4 { margin-bottom: 10px; color: #1a73e8; font-size: 16px; border-bottom: 1px solid #c4d9f0; padding-bottom: 8px; }
        .info-item { display: flex; justify-content: space-between; font-size: 14px; color: #333; margin-bottom: 5px; }
        .info-item span { font-weight: 600; }
        .bus-list { display: flex; flex-direction: column; gap: 12px; }
        .bus-card { border: 2px solid transparent; border-radius: 15px; padding: 15px; cursor: pointer; transition: all 0.2s ease-in-out; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .bus-card:hover { border-color: #1a73e8; transform: translateY(-3px); }
        .bus-card.selected { border-color: #1a73e8; background: #e9f3ff; }
        .bus-number { font-size: 16px; font-weight: 700; color: #1a73e8; }
        .bus-status { font-size: 13px; color: #666; }
        .map-container { background: white; border-radius: 15px; overflow: hidden; position: relative; }
        #map { width: 100%; height: 100%; }
        .loading { padding: 20px; text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="app-title"><i class="fas fa-bus"></i> Haryana Bus Tracker</div>
            <div class="subtitle">Real-time tracking with waypoints and ETAs</div>
        </header>
        <div class="main-content">
            <div class="sidebar">
                <div class="search-section">
                    <div class="search-tabs">
                        <button class="tab-button active" onclick="switchTab('route')">Search by Route</button>
                        <button class="tab-button" onclick="switchTab('bus-number')">Search by Bus No.</button>
                    </div>
                    <div id="route-panel" class="search-panel active">
                        <div class="input-group">
                            <label for="from-city">From</label>
                            <select id="from-city"><option value="">Select Departure City</option></select>
                        </div>
                        <div class="input-group">
                            <label for="to-city">To</label>
                            <select id="to-city"><option value="">Select Destination City</option></select>
                        </div>
                    </div>
                    <div id="bus-number-panel" class="search-panel">
                        <div class="input-group">
                            <label for="bus-number-input">Bus Number</label>
                            <input type="text" id="bus-number-input" placeholder="e.g., HR55A1234">
                        </div>
                    </div>
                    <button class="btn" id="search-btn" onclick="searchByRoute()"><i class="fas fa-search"></i> Find Buses</button>
                </div>

                <div id="route-info" class="route-info-panel">
                    <h4>Route Information</h4>
                    <div class="info-item">Duration: <span id="route-duration">--</span></div>
                    <div class="info-item">Distance: <span id="route-distance">--</span></div>
                </div>

                <div class="buses-section">
                    <div id="bus-list" class="bus-list">
                        <div class="loading"><span>Select a route to see live buses.</span></div>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        const POLLING_INTERVAL_MS = 3000;
        let map, infoWindow;
        let liveBusesData = [];
        let busMarkersOnMap = {};
        let stopMarkersOnMap = [];
        let currentRouteKey = null;
        let routePolyline = null;
        
        // Final, complete list of all selectable cities
        const CITIES = {
            chandigarh: "Chandigarh", gurgaon: "Gurgaon", ambala: "Ambala", hisar: "Hisar",
            rohtak: "Rohtak", faridabad: "Faridabad", karnal: "Karnal", sonipat: "Sonipat",
            panipat: "Panipat", yamunanagar: "Yamunanagar", sirsa: "Sirsa", rewari: "Rewari",
            kurukshetra: "Kurukshetra", kaithal: "Kaithal", jind: "Jind", jhajjar: "Jhajjar",
            fatehabad: "Fatehabad", manesar: "Manesar"
        };
        
        // The rest of the JavaScript is unchanged
        function populateCityDropdowns() {
            const fromCitySelect = document.getElementById('from-city');
            const toCitySelect = document.getElementById('to-city');
            const sortedCities = Object.keys(CITIES).sort((a, b) => CITIES[a].localeCompare(CITIES[b]));
            sortedCities.forEach(cityKey => {
                fromCitySelect.add(new Option(CITIES[cityKey], cityKey));
                toCitySelect.add(new Option(CITIES[cityKey], cityKey));
            });
        }
        async function fetchLiveBusData() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_live_buses`);
                if (!response.ok) return;
                liveBusesData = await response.json();
                updateBusListAndMarkers();
            } catch (error) { console.error("Failed to fetch live data:", error); }
        }
        function updateBusListAndMarkers() {
            const busList = document.getElementById('bus-list');
            let visibleBuses = currentRouteKey ? liveBusesData.filter(bus => bus.routeKey === currentRouteKey) : [];
            liveBusesData.forEach(bus => {
                const newPosition = { lat: bus.latitude, lng: bus.longitude };
                if (busMarkersOnMap[bus.id]) {
                    const marker = busMarkersOnMap[bus.id];
                    marker.setPosition(newPosition);
                    const icon = marker.getIcon();
                    icon.rotation = bus.bearing;
                    marker.setIcon(icon);
                } else {
                    const marker = new google.maps.Marker({
                        position: newPosition, map: map,
                        icon: { path: 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z', fillColor: '#1a73e8', fillOpacity: 1, strokeColor: 'white', strokeWeight: 1, scale: 1.3, rotation: bus.bearing, anchor: new google.maps.Point(12, 12) }
                    });
                    marker.addListener('click', () => {
                        infoWindow.setContent(`<h4>${bus.number}</h4><p>${bus.status}</p>`);
                        infoWindow.open(map, marker);
                    });
                    busMarkersOnMap[bus.id] = marker;
                }
                busMarkersOnMap[bus.id].setVisible(bus.routeKey === currentRouteKey);
            });
            busList.innerHTML = '';
            if(!currentRouteKey) { busList.innerHTML = `<div class="loading"><span>Select a route to see live buses.</span></div>`; }
            else if (visibleBuses.length === 0) { busList.innerHTML = `<div class="loading"><span>No live buses found on this route.</span></div>`; }
            visibleBuses.sort((a,b) => a.number.localeCompare(b.number)).forEach(bus => {
                const busCard = document.createElement('div');
                busCard.className = 'bus-card';
                busCard.innerHTML = `<div class="bus-number">${bus.number}</div><div class="bus-status">${bus.status}</div>`;
                busCard.addEventListener('mouseover', () => busMarkersOnMap[bus.id]?.setAnimation(google.maps.Animation.BOUNCE));
                busCard.addEventListener('mouseout', () => busMarkersOnMap[bus.id]?.setAnimation(null));
                busCard.addEventListener('click', () => {
                    map.panTo(busMarkersOnMap[bus.id].getPosition()); map.setZoom(12);
                    document.querySelectorAll('.bus-card').forEach(c => c.classList.remove('selected'));
                    busCard.classList.add('selected');
                });
                busList.appendChild(busCard);
            });
        }
        async function searchByRoute() {
            const fromCity = document.getElementById('from-city').value;
            const toCity = document.getElementById('to-city').value;
            if (!fromCity || !toCity || fromCity === toCity) { alert("Please select valid and different cities."); return; }
            currentRouteKey = `${fromCity}-${toCity}`;
            try {
                const response = await fetch(`${API_BASE_URL}/get_route?start=${fromCity}&end=${toCity}`);
                if (!response.ok) { alert('This route was not found on the server.'); return; }
                const data = await response.json();
                clearMap();
                drawRoutePolyline(data.route_points);
                displayStops(data.stops);
                updateRouteInfoPanel(data.total_duration_seconds, data.total_distance_meters);
                updateBusListAndMarkers();
            } catch (error) { console.error("Error fetching route data:", error); alert('Error fetching route data.'); }
        }
        function drawRoutePolyline(routeCoords) {
            routePolyline = new google.maps.Polyline({ path: routeCoords, strokeColor: '#1a73e8', strokeOpacity: 0.8, strokeWeight: 5, map: map });
            const bounds = new google.maps.LatLngBounds();
            routeCoords.forEach(point => bounds.extend(point));
            map.fitBounds(bounds, {padding: 50});
        }
        function displayStops(stops) {
            const pinSvgPath = "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z";
            const startEndIcon = { path: pinSvgPath, fillColor: '#D83131', fillOpacity: 1, strokeWeight: 1, strokeColor: '#FFFFFF', scale: 1.5, anchor: new google.maps.Point(12, 24) };
            const intermediateIcon = { path: pinSvgPath, fillColor: '#1a73e8', fillOpacity: 1, strokeWeight: 1, strokeColor: '#FFFFFF', scale: 1.3, anchor: new google.maps.Point(12, 24) };
            stops.forEach((stop, index) => {
                let iconToUse = (index === 0 || index === stops.length - 1) ? startEndIcon : intermediateIcon;
                const marker = new google.maps.Marker({ position: { lat: stop.lat, lng: stop.lng }, map: map, icon: iconToUse, title: stop.name });
                marker.addListener('click', () => {
                    infoWindow.setContent(`<h4>Stop: ${stop.name}</h4>`);
                    infoWindow.open(map, marker);
                });
                stopMarkersOnMap.push(marker);
            });
        }
        function updateRouteInfoPanel(durationSeconds, distanceMeters) {
            const panel = document.getElementById('route-info');
            const hours = Math.floor(durationSeconds / 3600);
            const minutes = Math.floor((durationSeconds % 3600) / 60);
            document.getElementById('route-duration').textContent = `${hours}h ${minutes}m`;
            document.getElementById('route-distance').textContent = `${(distanceMeters / 1000).toFixed(1)} km`;
            panel.style.display = 'block';
        }
        function clearMap() {
            if (routePolyline) routePolyline.setMap(null);
            stopMarkersOnMap.forEach(marker => marker.setMap(null));
            stopMarkersOnMap = [];
            document.getElementById('route-info').style.display = 'none';
            for (const busId in busMarkersOnMap) { busMarkersOnMap[busId].setVisible(false); }
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button, .search-panel').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            const searchBtn = document.getElementById('search-btn');
            searchBtn.innerHTML = tabName === 'route' ? '<i class="fas fa-search"></i> Find Buses' : '<i class="fas fa-crosshairs"></i> Track Bus';
            searchBtn.onclick = tabName === 'route' ? searchByRoute : () => alert('Bus number search not implemented yet.');
        }
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 29.0588, lng: 76.0856 }, zoom: 8, mapTypeControl: false, streetViewControl: false, styles: [ { stylers: [{ "saturation": -60 }] }] });
            infoWindow = new google.maps.InfoWindow();
            populateCityDropdowns();
            fetchLiveBusData();
            setInterval(fetchLiveBusData, POLLING_INTERVAL_MS);
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqFb_0TMh3ptL2FpIMDqjhk9i-Ps2Zhpg&callback=initMap"></script>
</body>
</html>
